<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGB Bridging Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Dosis:wght@200..800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-yellow': '#FFBB3D',
                        'brand-dark': '#121619',
                        'brand-green-dark': '#2D4839',
                        'brand-green-bright': '#08814B',
                        'brand-paper': '#fdfdf8',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Dosis', sans-serif;
            background: linear-gradient(135deg, #121619, #2D4839);
            color: #fdfdf8;
        }
        .font-display {
            font-family: 'Audiowide', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-field {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fdfdf8;
            transition: all 0.3s ease;
            font-family: 'Dosis', sans-serif;
        }
        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .input-field:focus {
            outline: none;
            background-color: rgba(0, 0, 0, 0.3);
        }
        .has-input {
            border-color: #FFBB3D !important;
            box-shadow: 0 0 8px rgba(255, 187, 61, 0.3);
        }
        .info-card {
            border-top: 4px solid #FFBB3D;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-label {
            font-weight: 400;
            color: rgba(255, 255, 255, 0.8);
        }
        .result-value {
            font-weight: 700;
            color: #ffffff;
        }
        .result-total {
            border-top: 2px solid #FFBB3D;
            margin-top: 8px;
            padding-top: 8px;
            font-size: 1.125rem; /* text-lg */
        }
        .editable-input {
            background-color: transparent;
            border: 1px solid transparent;
            text-align: right;
            font-weight: 700;
            color: #ffffff;
            width: 100%;
            border-radius: 0.5rem;
            padding-left: 1.75rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        .editable-input:focus {
             background-color: rgba(0, 0, 0, 0.3);
             outline: none;
        }
        .lvr-warning-text {
            color: #FFBB3D;
            text-shadow: 0 0 5px rgba(255, 187, 61, 0.5);
        }
        .lvr-alert-box {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 187, 61, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 187, 61, 0.3);
            color: #FFBB3D;
            border-radius: 0.5rem;
        }
        .note-box {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-left: 4px solid #08814B;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }
        .confirm-btn {
            background-color: #FFBB3D;
            color: #121619;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .confirm-btn:hover {
            background-color: #ffca64;
        }
        .reset-btn {
            cursor: pointer;
            margin-left: 0.5rem;
            color: rgba(255,255,255,0.5);
            transition: color 0.2s;
        }
        .reset-btn:hover {
            color: #FFBB3D;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <main class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="font-display text-5xl sm:text-6xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-yellow to-white pb-4">
                SGB Bridging Assistant
            </h1>
            <p class="mt-4 text-white/70 text-lg">
                Understand your bridging loan funding structure
            </p>
        </header>

        <!-- Top Section: Inputs -->
        <section id="inputs" class="mb-12 glass-card p-8 rounded-2xl shadow-2xl">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-12 gap-y-10 items-start">
                <!-- Property Being Sold Section -->
                <div>
                    <h2 class="font-display text-2xl font-bold text-white border-b-2 border-brand-yellow/50 pb-2 mb-6">Property Being Sold</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="selling-price" class="block text-sm font-medium text-white/80 mb-1">Estimated Gross Selling Price</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/50">$</span>
                                <input type="text" id="selling-price" class="input-field w-full pl-7 pr-4 py-2 rounded-lg" inputmode="numeric">
                            </div>
                        </div>
                        <div>
                            <label for="current-mortgage" class="block text-sm font-medium text-white/80 mb-1">Current Mortgage on Existing Property</label>
                             <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/50">$</span>
                                <input type="text" id="current-mortgage" class="input-field w-full pl-7 pr-4 py-2 rounded-lg" inputmode="numeric">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Property to be Purchased Section -->
                <div>
                    <h2 class="font-display text-2xl font-bold text-white border-b-2 border-brand-yellow/50 pb-2 mb-6">New Property to be Purchased</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="contract-price" class="block text-sm font-medium text-white/80 mb-1">Contract Price</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/50">$</span>
                                <input type="text" id="contract-price" class="input-field w-full pl-7 pr-4 py-2 rounded-lg" inputmode="numeric">
                            </div>
                        </div>
                        <div>
                            <label for="stamp-duty" class="block text-sm font-medium text-white/80 mb-1">Stamp Duty</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/50">$</span>
                                <input type="text" id="stamp-duty" class="input-field w-full pl-7 pr-4 py-2 rounded-lg" inputmode="numeric">
                            </div>
                        </div>
                        <div>
                            <label for="sundry-costs" class="block text-sm font-medium text-white/80 mb-1">Sundry Costs (Legal, etc.)</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/50">$</span>
                                <input type="text" id="sundry-costs" class="input-field w-full pl-7 pr-4 py-2 rounded-lg" inputmode="numeric">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Your Contribution & Assumptions Section -->
                <div>
                    <h2 class="font-display text-2xl font-bold text-white border-b-2 border-brand-yellow/50 pb-2 mb-6">Your Funds & Assumptions</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="current-funds" class="block text-sm font-medium text-white/80 mb-1">Current Funds available</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/50">$</span>
                                <input type="text" id="current-funds" class="input-field w-full pl-7 pr-4 py-2 rounded-lg" inputmode="numeric">
                            </div>
                        </div>
                        <div>
                            <label for="interest-rate" class="block text-sm font-medium text-white/80 mb-1">Bridging Loan Interest Rate</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-white/50">%</span>
                                <input type="text" id="interest-rate" class="input-field w-full pr-7 pl-4 py-2 rounded-lg" value="8.92" inputmode="decimal">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bottom Section: Results -->
        <section id="results-output" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- This will be populated by JS -->
        </section>
        
        <!-- Timeline Section -->
        <section id="timeline-section" class="mt-8 md:col-span-2 glass-card p-8 rounded-2xl shadow-2xl">
             <h2 class="font-display text-3xl font-bold text-white border-b-2 border-brand-yellow/50 pb-2 mb-6">Understand the Timeline</h2>
             <ol id="timeline-list" class="space-y-4 text-white/90 list-decimal list-inside">
                <!-- This will be populated by JS -->
             </ol>
        </section>
    </main>

    <script>
        // --- State Management ---
        let isIcapManuallySet = false;
        let isAdditionalLoanManuallySet = false;

        // --- DOM Element References ---
        const resultsOutput = document.getElementById('results-output');
        const timelineList = document.getElementById('timeline-list');
        const inputIds = ['selling-price', 'current-mortgage', 'contract-price', 'stamp-duty', 'sundry-costs', 'current-funds', 'interest-rate'];

        // --- Helper Functions ---

        function toggleInputBorder(element) {
            if (element.value) {
                element.classList.add('has-input');
            } else {
                element.classList.remove('has-input');
            }
        }

        function autoFormatNumber(event) {
            const input = event.target;
            if (input.id === 'interest-rate') return;
            const value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = Number(value).toLocaleString('en-US');
            } else {
                input.value = '';
            }
        }

        function parseCurrency(id) {
            const element = document.getElementById(id);
            if (!element) return 0;
            const value = element.value.replace(/[^0-9.]/g, "");
            return parseFloat(value) || 0;
        }
        
        function parseCurrencyFromText(id) {
            const element = document.getElementById(id);
            if (!element) return 0;
            const value = element.textContent.replace(/[^0-9.]/g, "");
            return parseFloat(value) || 0;
        }

        function parseDecimal(id) {
            const element = document.getElementById(id);
            if (!element) return 0;
            const value = element.value.replace(/[^0-9.]/g, "");
            return parseFloat(value) || 0;
        }

        function formatCurrency(number) {
            return new Intl.NumberFormat('en-AU', {
                style: 'currency',
                currency: 'AUD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(number);
        }

        function formatSimpleNumber(number) {
            return Number(number.toFixed(2)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        // --- Main Calculation Logic ---
        function updateCalculations(options = {}) {
            // 1. Read all input values
            const sellingPrice = parseCurrency('selling-price');
            const currentMortgage = parseCurrency('current-mortgage');
            const contractPrice = parseCurrency('contract-price');
            const stampDuty = parseCurrency('stamp-duty');
            const sundryCosts = parseCurrency('sundry-costs');
            const currentFunds = parseCurrency('current-funds');
            const interestRate = parseDecimal('interest-rate');

            // 2. Perform Calculations
            const fundsForNewPurchase = contractPrice + stampDuty + sundryCosts;
            const fundsToPayOffMortgage = currentMortgage;
            const totalFundsRequired = fundsForNewPurchase + fundsToPayOffMortgage;
            const maxBridgingLoan = Math.min(sellingPrice * 0.85, totalFundsRequired);
            const peakDebt = totalFundsRequired - currentFunds;
            const assessedRate = interestRate + 1.0;
            
            let additionalNewLoan = isAdditionalLoanManuallySet ? parseCurrency('additional-loan-input') : 0;
            if (additionalNewLoan > maxBridgingLoan) {
                additionalNewLoan = maxBridgingLoan;
            }
            
            const finalBridgingLoan = Math.max(0, maxBridgingLoan - additionalNewLoan);
            
            const autoIcap = (() => {
                const dailyRate = (assessedRate / 100) / 365;
                const daysInMonths = [];
                const now = new Date();
                let currentYear = now.getFullYear();
                let currentMonth = now.getMonth();
                for (let i = 0; i < 12; i++) {
                    daysInMonths.push(getDaysInMonth(currentYear, currentMonth));
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                }
                let compoundingPrincipal = finalBridgingLoan;
                let totalIcap = 0;
                for (const days of daysInMonths) {
                    const monthlyInterest = compoundingPrincipal * dailyRate * days;
                    totalIcap += monthlyInterest;
                    compoundingPrincipal += monthlyInterest;
                }
                return totalIcap;
            })();
            
            const icap = isIcapManuallySet ? parseCurrency('icap-input') : autoIcap;
            const icapDescription = isIcapManuallySet ? '(Self Entered)' : `(Calculated at assessed rate of ${assessedRate.toFixed(2)}%)`;

            const totalPeakDebt = peakDebt + icap;
            const peakSecurity = sellingPrice + contractPrice;
            const peakLvr = peakSecurity > 0 ? (totalPeakDebt / peakSecurity) * 100 : 0;

            const minimumEndDebt = totalPeakDebt - maxBridgingLoan;
            const totalEndDebt = minimumEndDebt + additionalNewLoan;
            const endSecurity = contractPrice;
            const endLvr = endSecurity > 0 ? (totalEndDebt / endSecurity) * 100 : 0;

            let lvrAlertHTML = '';
            if (peakLvr > 80) {
                const extraFundsNeeded = totalPeakDebt - (peakSecurity * 0.80);
                lvrAlertHTML = `<div class="lvr-alert-box"><h4 class="font-bold">Peak Debt LVR Alert!</h4><p>Peak LVR cannot exceed 80%. You need to contribute extra funds of <strong class="font-bold">${formatCurrency(extraFundsNeeded)}</strong>.</p></div>`;
            }

            // 3. Generate HTML for all cards
            const card1_FundsRequired = `
                <div class="info-card glass-card p-6 rounded-lg shadow-lg">
                    <h3 class="font-display text-xl font-bold text-white mb-4">Total Funds Required</h3>
                    <div class="space-y-2">
                        <div class="result-item">
                            <span class="result-label">For New Purchase:</span>
                            <span class="result-value">${formatCurrency(fundsForNewPurchase)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">To Payout Existing Loan:</span>
                            <span class="result-value">${formatCurrency(fundsToPayOffMortgage)}</span>
                        </div>
                        <div class="result-item result-total">
                            <span class="result-label">Total Funds Required:</span>
                            <span class="result-value">${formatCurrency(totalFundsRequired)}</span>
                        </div>
                    </div>
                </div>`;

            const card2_PeakDebt = `
                <div class="info-card glass-card p-6 rounded-lg shadow-lg">
                    <h3 class="font-display text-xl font-bold text-white mb-4">Peak Debt & LVR</h3>
                    <div class="space-y-2">
                        <div class="result-item">
                            <span class="result-label">Peak Debt (Loan Required):</span>
                            <span class="result-value" id="peak-debt-value">${formatCurrency(peakDebt)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">(+) Interest (ICAP):</span>
                            <div class="relative flex items-center w-1/2">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/50">$</span>
                                <input type="text" id="icap-input" class="editable-input input-field" value="${formatSimpleNumber(icap)}" inputmode="numeric">
                                <button id="reset-icap-btn" class="reset-btn" title="Reset to calculated value">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-white/60 pl-4" id="icap-description">${icapDescription}</p>
                        <div class="result-item result-total">
                            <span class="result-label">Total Peak Debt:</span>
                            <span class="result-value" id="total-peak-debt-value">${formatCurrency(totalPeakDebt)}</span>
                        </div>
                        <div class="result-item mt-4">
                            <span class="result-label">Peak Security:</span>
                            <span class="result-value" id="peak-security-value">${formatCurrency(peakSecurity)}</span>
                        </div>
                        <div class="result-item font-bold text-lg">
                            <span class="result-label">Peak LVR:</span>
                            <span class="result-value ${peakLvr > 80 ? 'lvr-warning-text' : ''}" id="peak-lvr-value">${peakLvr.toFixed(2)}%</span>
                        </div>
                        <div id="lvr-alert">${lvrAlertHTML}</div>
                    </div>
                </div>`;
            
            const card3_MaxBridging = `
                 <div class="info-card glass-card p-6 rounded-lg shadow-lg">
                    <h3 class="font-display text-xl font-bold text-white mb-4">Bridging Loan Details</h3>
                    <div class="space-y-2">
                         <div class="result-item">
                            <span class="result-label">Max Bridging Loan:</span>
                            <span class="result-value" id="max-bridging-loan-value">${formatCurrency(maxBridgingLoan)}</span>
                        </div>
                        <p class="text-xs text-white/60 pt-1">(Lower of 85% of property value or Total Funds Required)</p>
                        <div class="result-item result-total">
                            <span class="result-label">Final Bridging Loan:</span>
                            <span class="result-value" id="final-bridging-loan-value">${formatCurrency(finalBridgingLoan)}</span>
                        </div>
                         <p class="text-xs text-white/60 pl-4">(Max Bridging Loan - Additional New Loan)</p>
                    </div>
                </div>`;
            
            const card4_Residual = `
                <div class="info-card glass-card p-6 rounded-lg shadow-lg">
                    <h3 class="font-display text-xl font-bold text-white mb-4">Residual Lending (End Position)</h3>
                    <div class="space-y-2">
                        <div class="result-item">
                            <span class="result-label">Minimum End Debt:</span>
                            <span class="result-value" id="min-end-debt-value">${formatCurrency(minimumEndDebt)}</span>
                        </div>
                        <p class="text-xs text-white/60 pl-4">(Total Peak Debt - Max Bridging Loan)</p>
                         <div class="result-item">
                            <span class="result-label">Additional New Loan:</span>
                            <div class="relative flex items-center w-1/2">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/50">$</span>
                                <input type="text" id="additional-loan-input" class="editable-input input-field" value="${formatSimpleNumber(additionalNewLoan)}" inputmode="numeric">
                                <button id="confirm-additional-loan" class="confirm-btn">Confirm</button>
                            </div>
                        </div>
                        <p class="text-xs text-white/60 pl-4">(Max: ${formatCurrency(maxBridgingLoan)}, reduces bridging loan)</p>
                        <div class="result-item result-total">
                            <span class="result-label">Total End Debt:</span>
                            <span class="result-value" id="total-end-debt-value">${formatCurrency(totalEndDebt)}</span>
                        </div>
                        <div class="result-item mt-4">
                            <span class="result-label">End Security:</span>
                            <span class="result-value" id="end-security-value">${formatCurrency(endSecurity)}</span>
                        </div>
                        <div class="result-item font-bold text-lg">
                            <span class="result-label">End LVR:</span>
                            <span class="result-value ${endLvr > 80 ? 'lvr-warning-text' : ''}" id="end-lvr-value">${endLvr.toFixed(2)}%</span>
                        </div>
                        <div class="note-box">
                            <p><strong>Note:</strong> Review end LVR to ensure that it is allowable under the applicable LVR policy.</p>
                            <p id="borrowing-capacity-note" class="mt-2"><strong>Note:</strong> Check the borrowing capacity for the end debt amount of ${formatCurrency(totalEndDebt)}.</p>
                        </div>
                    </div>
                </div>`;

            // 4. Display the results in the container
            resultsOutput.innerHTML = `
                ${card1_FundsRequired}
                ${card2_PeakDebt}
                ${card3_MaxBridging}
                ${card4_Residual}
            `;
            
            // 5. Update Timeline
            updateTimeline({currentMortgage, peakDebt, peakLvr, totalPeakDebt, peakSecurity, maxBridgingLoan, finalBridgingLoan, totalEndDebt, endLvr, additionalNewLoan, endSecurity, icap});
            
            // 6. Style editable inputs
            ['icap-input', 'additional-loan-input'].forEach(id => {
                const input = document.getElementById(id);
                if(input) toggleInputBorder(input);
            });
        }
        
        function updateTimeline(data) {
            const {currentMortgage, peakDebt, peakLvr, totalPeakDebt, peakSecurity, maxBridgingLoan, finalBridgingLoan, totalEndDebt, endLvr, additionalNewLoan, endSecurity, icap} = data;
            let timelineHTML = '';

            // Point 1
            timelineHTML += `<li>After the bridging loan is settled, first of all your existing mortgage will be refinanced. SGB will pay the <strong class="text-brand-yellow">${formatCurrency(currentMortgage)}</strong> to your existing lender and possess the current property to be later sold as collateral.</li>`;
            // Point 2
            timelineHTML += `<li>Total funds required initially is <strong class="text-brand-yellow">${formatCurrency(peakDebt)}</strong> which covers your current mortgage plus the purchase price of new property along with stamp duty and fees.</li>`;
            // Point 3
            timelineHTML += `<li>SGB will calculate 12 months of interest on the bridging loan portion and capitalize it to your peak debt. The capitalized interest is <strong class="text-brand-yellow">${formatCurrency(icap)}</strong> in your case.</li>`;
            // Point 4
            if (peakLvr > 80) {
                const extraFundsNeeded = totalPeakDebt - (peakSecurity * 0.80);
                timelineHTML += `<li>The maximum LVR allowed by SGB on peak debt is 80%, so you will need to contribute <strong class="text-brand-yellow">${formatCurrency(extraFundsNeeded)}</strong> to get the final peak LVR at 80.00%.</li>`;
            } else {
                timelineHTML += `<li>The maximum LVR allowed by SGB on peak debt is 80%. Your peak LVR is <strong class="text-brand-yellow">${peakLvr.toFixed(2)}%</strong> which is within SGB's policy requirement.</li>`;
            }
            // Point 5 & 6
            timelineHTML += `<li>Once the purchase settles, you will have 12 months of bridging period within which you will need to sell the current property.</li>`;
            timelineHTML += `<li>Since the interest amount for 12 months is already capitalized to the peak debt, you are not required to pay any interest up until the first 12 months or till the current property is sold, whichever occurs first.</li>`;
            // Point 7
            timelineHTML += `<li>The 85% of your current property's valuation is considered as the maximum bridging loan amount which is <strong class="text-brand-yellow">${formatCurrency(maxBridgingLoan)}</strong> in your case. The 15% is considered as a buffer for any fluctuation on the sale price.</li>`;
            // Point 8
            timelineHTML += `<li>Once the property is sold, the amount equaling to the bridging loan i.e, <strong class="text-brand-yellow">${formatCurrency(finalBridgingLoan)}</strong> will be used to pay off the peak debt. Any sale proceed over the bridging loan amount will be available to you.</li>`;
            // Point 9
            timelineHTML += `<li>So after paying the peak debt down by <strong class="text-brand-yellow">${formatCurrency(maxBridgingLoan)}</strong>, your end debt will be <strong class="text-brand-yellow">${formatCurrency(totalEndDebt - additionalNewLoan)}</strong>. This is the minimum end debt amount, and your end LVR will be <strong class="text-brand-yellow">${((totalEndDebt - additionalNewLoan) / (endSecurity || 1) * 100).toFixed(2)}%</strong>.</li>`;
            // Point 10 (Conditional)
            if (additionalNewLoan > 0) {
                 timelineHTML += `<li>If your borrowing capacity allows, you can increase your end debt by <strong class="text-brand-yellow">${formatCurrency(additionalNewLoan)}</strong> such that the total end debt becomes <strong class="text-brand-yellow">${formatCurrency(totalEndDebt)}</strong> at an end LVR of <strong class="text-brand-yellow">${endLvr.toFixed(2)}%</strong>. This also reduces your bridging loan amount meaning you will retain the additional amount from the net sale proceeds of your property.</li>`;
            }
            // Point 11
            timelineHTML += `<li>So your final end debt will be <strong class="text-brand-yellow">${formatCurrency(totalEndDebt)}</strong> and you will start paying P&I repayments on this amount moving forward.</li>`;

            timelineList.innerHTML = timelineHTML;
        }

        // --- Event Listeners ---
        inputIds.forEach(id => {
            const inputElement = document.getElementById(id);
            if (inputElement) {
                inputElement.addEventListener('input', (e) => {
                    if (e.target.id !== 'interest-rate') {
                        autoFormatNumber(e);
                    }
                    toggleInputBorder(e.target);
                    isIcapManuallySet = false;
                    isAdditionalLoanManuallySet = false;
                    updateCalculations();
                });
            }
        });

        resultsOutput.addEventListener('input', (event) => {
            const target = event.target;
            if (target && (target.id === 'icap-input' || target.id === 'additional-loan-input')) {
                 autoFormatNumber(event);
                 toggleInputBorder(target);
            }
        });

        resultsOutput.addEventListener('click', (event) => {
            const target = event.target;
            const resetBtn = target.closest('#reset-icap-btn');

            if (target && target.id === 'confirm-additional-loan') {
                isAdditionalLoanManuallySet = true;
                updateCalculations();
            }
            if (resetBtn) {
                isIcapManuallySet = false;
                updateCalculations();
            }
        });
        
         resultsOutput.addEventListener('focusout', (event) => {
            if (event.target && event.target.id === 'icap-input') {
                 isIcapManuallySet = true;
                 updateCalculations();
            }
        });


        // --- Initial Setup ---
        inputIds.forEach(id => {
            const inputElement = document.getElementById(id);
            if(inputElement) {
                toggleInputBorder(inputElement);
            }
        });
        updateCalculations();
    </script>

</body>
</html>
